# virtualenv

* Windows

```bash
    pip install virtualenv
    python -m virtualenv <virtual_name>

    .\\venv\Scripts\activate 
```

# django

## settings.py

* > django 3.1:
  ```
  BASE_DIR = Path(__file__).resolve().parent.parent
  STATIC_ROOT = BASE_DIR/'static'
  ```

## start django project

```bash
    pip install django
    #powershell
    django-admin startproject <project_name>

    # inside the project directory
    python manage.py runserver
```

## MVT

* model view template
    * model: define the data for your application and abstraction layer
        * view: the logic for your application
            * function-based view (FBVs)
                * take HTTPRequest type object
            * class-based view (CBVs)
                * compared with function-based view, fewer lines of code need to be used
                * inherit Django's generic views
                * ``.as_view()``: allow the view class to be mapped to a URL endpoint
            * CURD

              |  Type  | class      |
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |:------:|:-----------|
              | create | CreateView |
              | Upate  | UpdateView |
              | Delete | DeleteView |
              |  Read  | DetailView |

* template: HTML files

## Structure of directories

### Django Project

|   Files   | Meaning               |
|:---------:|:----------------------|
| manage.py | manage django project |

#### manage.py

* ``python3 manage.py <code>``

|      Code      | Meaning                                                                                                                                                                        | Example                                                 |
|:--------------:|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:--------------------------------------------------------|
|   runserver    | start the HTTP server. Automatically restart in the terminal when scripts change. Except for database changes                                                                  | runserver (host:)port                                   |
|    startapp    | create a new Django app                                                                                                                                                        |
|     shell      | start a Python interpreter                                                                                                                                                     | python manage.py shell                                  |
|    dbshell     | start an interactive shell connected to database                                                                                                                               |
| makemigrations | generate database change instructions from model definitions => help identify any changes to the models and will propagate these changes into the database while the migration | python manage.py makemigrations <app_folder>            | 
| showmigrations | see the migration status                                                                                                                                                       | python manage.py showmigrations                         |
|   sqlmigrate   | see the process how Django transforms a model into an actual database table                                                                                                    | python manage.py sqlmigrate <app_folder> <migrate_file> |
|    migrate     | actually apply migrations generated by the makemigrations                                                                                                                      | python manage.py migrate <app_folder>                   | 
|      test      | run automated tests                                                                                                                                                            |

##### shell

* advantage: no need to maintain sql script

```python
from reviews.models import Publisher

publisher = Publisher(name='...', website='...', email='...')

# write the object into the database
publisher.save()

# see the object attributes
publisher.email

# change the object 
publisher.email = '...'

# create an object in a single step
from reviews.models import Contributor

contributor = Contributor.objects.create(first_names='Rowel', last_names='Atienza', email='RowelAtienza@example.com')

# get object
from reviews.models import Publisher

publisher = Publisher.objects.get(name='PacktPublishing')

## primary key or id
publisher = Publisher.objects.get(pk=2)
publisher = Publisher.objects.get(id=2)

# all(): retrieve all the objects -> return QuerySet
contributors = Contributor.objects.all()
## get specific object
contributors[0]  # because of QuerySet
contributors[0].first_names

# create an object with foreign object
book = Book.objects.create(title='...', publication_date='...', isbn='...', publisher=publisher)

# many-to-many relationships
book = Book.objects.get(title='Advanced Deep Learning with Keras')
contributor = Contributor.objects.get(first_names='Rowel')
book_contributor = BookContributor(book=book, contributor=contributor, role='AUTHOR')

## add: only one object - no need to use the relationship to connect objects
book.contributors.add(contributor, through_defaults={'role': 'EDITOR'})

## create non-present & non-relational object in the database
book.contributors.create(first_names='Packtp', last_names='Editor Example', email='PacktEditor2@example.com',
                         through_default
s = {'role': 'EDITOR'})

## set: add a list of contributors for a book
contributor1 = Contributor.objects.create(first_names='Stephen', last_names='Stephen', email='StephenKing@example.com')
contributor2 = Contributor.objects.create(first_names='Peter', last_names='Straub', email='PeterStraub@example.com')
book = Book.objects.create(title='The Talisman', publication_date=date(2012, 9, 25), isbn='9781451697216',
                           publisher=publishe
r)
book.contributors.set([contributor1, contributor2], through_defaults={'role': 'CO_AUTHOR'})

# filter
Contributor.objects.filter(first_names='Peter')

## greater than
book = Book.objects.filter(publication_date__gt=date(2014, 1, 1))
## less than: lt
## less than or equal to: lte
## greater than or equal to: gte
## string contain: contains
## exclude: exclude
### chains of query
Book.objects.filter(publication_date__gt=date(2014, 1, 1)).filter(...)

# order: order_by
## descending:
Book.objects.order_by('-title')

# get dictionaries instead of objects
publishers = Publisher.objects.all().values()

# query data with relationships
## query by foreign key: __
Book.objects.filter(publisher__name='Packt Publishing')
## query by model name in lowercase
Publisher.objects.get(book__title='..')
## query by object instance: set.all()
book = Book.objects.get(title='')  # optional
publisher = Publisher.object.get(name='')
publisher.book_set.all()

# filter + update/delete
Contributor.objects.filter(last_names='...').update(first_names='')



```

#### <project> directory

* next to ``manage.py``

|    File     | Meaning                     |
|:-----------:|:----------------------------|
| __init__.py | indicate python module      |
|   urls.py   | global URL mappings         |
| settings.py | django settings             |
|   asgi.py   | communicate with Django App |
|   wsgi.py   | communicate with Django App |

##### Settings.py

* global variables

> Do not use/import self-created settings file. Use **django.conf** or settings will be affected by
> 1. other different settings.py file
> 2. Hidden settings of Django
> 3. Third-party libraries settings

> if one setting variable is missing, the value will fall back to the default value of Django
>
> If using self-created settings files, the value will not fall back

|    variable    | Meaning                                                                                  |
|:--------------:|:-----------------------------------------------------------------------------------------|
|   SECRET_KEY   | for hashing, tokens, cryptographic functions                                             |
|     DEBUG      | True: automatically display exceptions to browser. If production, it should be set False |
| INSTALLED_APPS | Django third-party apps                                                                  |
|  ROOT_URLCONF  | Django loads first to find URLs. index view URL map                                      |
|   TEMPLATES    ||
|    APP_DIRS    | look in a templates directory inside each INSTALLED_APP when loading templates           |

### django app

|    File     | Meaning                                                                         |
|:-----------:|:--------------------------------------------------------------------------------|
| __init__.py | indicate python module                                                          |
|  admin.py   | built-admin site for viewing and edition data with GUI                          |
|   apps.py   | configuration for the metadata of app                                           |
|  models.py  | define the models for applications. Each model transforms into a database table |
| migrations  | automatically record changes to database. generated when running manage.py      | 
|  tests.py   | test code                                                                       |
|  views.py   | django views                                                                    |

## QueryDict Object

* immutable
    * require `copy` to edit the object

```python
qd = QueryDict('k=a&k=b&k=c')
qd['k']  # c
qd.get('k')  # c
qd.getlist('k')  # ['a', 'b', 'c']
qd.getlist('g')  # []
```

```python
qd2 = qd.copy()
qd2['k'] = 'd'
qd2['k']  # change c -> d  
```

> Note:
>
> name = request.GET.get('name', 'world') => empty value if name=""
> use name = request.GET.get('name') or 'world'

## Functions

### Render

* a shortcut function that returns an HttpResponse instance
* two arguments
    * request
    * name/relative path of the template being rendered
        * in the same app directory
    * (optional) render context containing variables available in the template

## ORM

* convert object-oriented Python code into actual database constructs
* advantage: avoid sql injection

### Migration

* transformation of Python code into database structures

# HTTP status

| Status  | Meaning                                           |
|:-------:|:--------------------------------------------------|
| 100-199 | protocol changes, more data is requires. No worry |
| 200-299 | successful                                        |
| 300-399 | redirect response                                 |
| 400-499 | error on client side                              |
| 500-599 | error on server side                              |

# URL Path

* Project root url
    * settings.py: ROOT_URLCONF
    * determine the URL configuration file to be used first
* include:
    * on django project level
    * a shortcut that allows you to combine URL configurations
        * a project has many application. each application has their own URL configurations

# Template

* no need to hardcode template
    * settings.py: TEMPLATES

| Variable | Meaning                                                                                                          |
|:--------:|:-----------------------------------------------------------------------------------------------------------------|
| BACKEND  | the template engine Django uses to work with HTML templates. default - DjangoTemplates                           |
|   DIRS   | the directories where Django searches for the templates. If empty, search for templates under each app directory |                                |
| APP_DIRS | True: look for templates in the installed apps under INSTALLED_APPS (settings)                                   |
| OPTIONS  | template engine-specific settings e.g. context processors                                                        |

## Template Language

### Template Variables

* value carried by the variables will be replaced in the template

```commandline
  {{ variable }}
```

### Template Tags

* for control flow, like if else or for loop

```commandline
  {% for element in element_list %}
    ...
  {% endfor %}
```

### Comments

```commandline
  {% comment %}
    ...
    
  {% endcomment %}
```

### Filters

```commandline
 {{ variable|<filter> }}    
```

* `<filter>`:
    * lower: convert string into lowercase
    * title: convert string into capital

# Admin

* an django app: settings.py: django.contrib.admin
* url: admin
* when the app initialized, it calls its autodiscover() to detect any other installed apps contain an admin module

## Create a superuser

```commandline
python3 manage.py createsuperuser
```

## change password

```commandline
python manage.py changepassword <username>

```

## register models

* models can be managed by authentication
* use the admin's app to register our models
    * django app: admin.py
    * make models available to the admin app by adding it to a registry of classes contained in admin.site._registry

## Model Admin

# <app>.admin.py

|   Attribute    | Meaning                                                         | Determined by                                                                  | Note                                          |
|:--------------:|:----------------------------------------------------------------|:-------------------------------------------------------------------------------|:----------------------------------------------|
| date_hierarchy | represent date list on the web                                  |
|  list_display  | represent the column title of tables                            | __str__ :from django.contrib.admin import ModelAdmin ; ModelAdmin.list_display | Only a single column or customized ModelAdmin |
|  list_filter   | the right bar, filter                                           ||
| search_fields  | the top bar of search                                           |
|    exclude     | hide fields on the admin site                                   |
|     fields     | only fields in the list of fields can be seen on the admin site |
|   fieldsets    | set the title of fields or no title                             |

## Customize Admin Site

* AdminSite class
* the attribute can be overridden

|  Attribute  | Meaning                                         |
|:-----------:|:------------------------------------------------|
| site_header | text at the top of every admin page             |
| site_title  | text in the title bar of the browser            |
|  site_url   | link to View Site                               |
| index_title | text on the index page of the admin application |

### get_url()

* [specify your custom URLs before the django admin URLs](https://stackoverflow.com/a/68368300)

# Static Files

* django refused to serve static files in production
    * serving static files keeping Python process busy for the duration of the request
    * let web server deal with the static files
* use staticfileds app
    * static view is designed only for use in development
        * will not work is DEBUG setting is False
* when deploy to production, only change the STATIC_URL in settings.py
    * STATIC_URL: the prefix path of the static file on the web url

|      Features       | Meaning                                                                                                                                                                                                                                                                                                                                                                   |
|:-------------------:|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| static template tag | automatically generate the url to a static URL/path for assets and HTML inside a template. Without it, developers have to hardcode the long urls of static files in css, html files                                                                                                                                                                                       |
|    View (static)    | receive requests and server/load static files                                                                                                                                                                                                                                                                                                                             |
| static file finders | locate the static files on the disk                                                                                                                                                                                                                                                                                                                                       |
|    collectstatic    | finds all static files (files are copied into the STATIC_ROOT, the location is predictable by the frontend web server) and move them outside the Django Project directory into a web server directory, e.g. /var/www/bookr/static/log.png for security. You can also move the an intermediary directory and have your development process move to a CDN or another server |
|     findstatic      | show which static file on disk is loaded for a particular request; help debug to see which static files are not loaded                                                                                                                                                                                                                                                    |

## file finders

### the process of Static files being loaded

1. When receiving requests, convert URL to directory path => find the static files

### Types

#### AppDirectoriesFinder

    * find static files inside each app directory, called static
    * recommend to store static files specific for the app

##### Process

1. use {% load static %} to load the library in html files
2. project_directory/templates: add html files
3. project_directory/settings.py:
    * TEMPLATES['DIRS]: [os.path.join(BASE_DIR, 'templates')] => locate template directory
4. project_directory/urls.py:
    * urlpatterns = [path('', TemplateView.as_view(template_name='index.html'))] => set url path for views

#### FileSystemFinder

* recommend to store common static files for the whole project
* global static directory used in many different projects
* settings: STATICFILES_DIRS
* if static files with the same name in different projects, use the one listed first in the list

##### Process

1. project_directory/static: add css files
2. settings.py: add STATICFILES_DIRS = [os.path.join(BASE_DIR, 'static')]
    * can add extra path
    * set the static under the base dir as STATICFILES_DIRS
    * the priority is the highest

> default:AppDirectoriesFinder => find all statics in all apps under the root

3. use {% load static %} to load the library in html files

### static file namespacing

* issue: static files have the same name in different directory
    * the URL path of static files is relative to the static directory
        * /static/logo.png
* solution: add directory in static directory
    * reviews_app -> static -> reviews -> logo.png

## static template tag

* point to the actual file => quotes

```commandline
<img src="{% static 'logo.png' %}">
```

* point to the variable representing the actual file => without quotes

```commandline
<img src="{% static image_file %}">
```

* create a variable to use repeatedly

```commandline
<img src="{% static 'logo.png' as logo_path %}">

<img src="{% static logo_path %}">
```

## collectstatic

### frontend web server

* designed to route requests to applications (like django) or read static files from disk
* can handle requests faster, not able to generate dynamic content (like django)
* e.g. Apache HTTPD, Nginx, lighttpd

### Process

* project_directory: add a directory, e.g. static_production_test
* settings.py: STATIC_ROOT = os.path.join(BASE_DIR, 'static_production_test')
* Tuple: ('web server path', 'static files path in django')
  STATICFILES_DIRS = [
  os.path.join(BASE_DIR, 'static'),
  ('images', os.path.join(BASE_DIR, 'static_images')), # => web server:images/image.jpg
  ('css', os.path.join(BASE_DIR, 'static_css')),
  ]


* terminal: python3 manage.py collectstatic

=> copy all the files for all installed apps

## findstatic

```commandline
python manage.py findstatic <-v0/-v2> <static file name> <static file name> <static file name>
```

* for static files already namespaced

```commandline
python manage.py findstatic <full_relative_path/static file name>
```

## cache static files

* not cache dynamic responses (rendered templates)
    * designed to be dynamic
        * to get the latest version
    * quite small in size, compated with assets like images => no speed advantage when caching
* collectstatic: append a hash of their content to the filename
    * e.g. logo.f30ba08c60ba.png
    * file name changing only when the content changes => browser will always download the new content

* ManifestFilesStorage
    * the engine will automatically insert the hashed filename when using the static template tag

* other custom storage engines
    * e.g. CDN, Amazon S3, Google Cloud bucket

### Process

1. settings.py: STATICFILES_STORAGE = 'django.contrib.staticfiles.storage.ManifestStaticFilesStorage'
2. python manage.py collectstatic
3. see staticfiles.json: check the latest version of files

# Form

## errors

|      error       | meaning                                                                            |
|:----------------:|:-----------------------------------------------------------------------------------|
|   field errors   | apply to a specific field                                                          |
| non-filed errors | display at the top of the form. for security, specfic error will not show to users |

## element

| element | meaning                                                                                                                           | Note                                             |
|:-------:|:----------------------------------------------------------------------------------------------------------------------------------|:-------------------------------------------------|
| method  | http method to submit the form, e.g. get or post                                                                                  ||
| action  | refer to the URL (or path)                                                                                                        ||
| enctype | encoding type of the form. default: value is omitted => application/x-www-form-urlencoded; uploading files => multipart/form-data | django handles the different types automatically |

## CSRF token

## GET vs POST

| Method | Scenario  1                                                                                 | Scenario                                       | Note                                                                                            |
|:------:|:--------------------------------------------------------------------------------------------|:-----------------------------------------------|:------------------------------------------------------------------------------------------------|
|  GET   | Idempotent: no mather how many times uses refresh the page, you will get the same data back | will pass sensitive data though URL parameters | the maximum length of URL allowed by a browser cab be short compared to the size of a POST body |
|  POST  | Non-idempotent: repeating POST requests will update the information                         |                                                | Django only applies CSRF projection to POST                                                     |

### Get

* '/search/<str: search>/<int:page>/<str: order>'
    * the URL is bad since it is limited by the order of parameters. If page <int> not proivided, the page will not be
      sorted
* use query parameters: optional
    * ?search=search+term:
    * ?search=search+term&page=2
    * ?search=search+term&order=author
    * ?search=search+term&page=2&order=author

## Widget

|      Files       | Widget                                                                                                     | Note                             |
|:----------------:|:-----------------------------------------------------------------------------------------------------------|----------------------------------|
|   text <input>   | CharField                                                                                                  |
| password <input> | PasswordInput                                                                                              |
|   RadioSelect    | ChoiceField                                                                                                |
|     Textarea     | CharField                                                                                                  | height & width can be set by CSS |
|      Input       | HiddenInput                                                                                                |
|     checkbox     | BooleanField                                                                                               |
|     choices      | ChoiceFiled                                                                                                |
| multiple choices | MultipleChoiceField                                                                                        |
|      Number      | IntegerField, FloatField, DecimalField                                                                     |
|      email       | EmailField                                                                                                 |
|       Date       | DateField, DateField(input_formats=[...]), forms.DateField(widget=forms.DateInput(attrs={'type': 'date'})) | DateField: text format           |
|   HiddenInput    | no HiddenField => forms.CharField(widget=forms.HiddenInput, initial='Hidden Value')                        |

## Render a form in a template

| Layout methods | Meaning                                                |
|:--------------:|:-------------------------------------------------------|
|    as_table    | render form as table rows                              |
|     as_url     | render form as list items (li) inside ul or ol element |
|      as_p      | render form as p tags                                  |

## validating forms

* unbound: the form of post data is unvalidated
    ```
    form = ExampleForm(
    ```
* bound: the form of post data is validated
    ```
    form = ExampleForm(request.POST)
    ```
    * if form is valid, redirect the sucess page
        * in case users reloading pages and resend the data
        ```
          if form.is_valid():
            return redirect('/success-page')
        ```
        * form.cleaned_data
            * will not show csrf tokens and button string

* ValidationError
    * if input data is wrong, django automatically raises the error

### built-in filed validation

|    Argument    | Meaning                                                |
|:--------------:|:-------------------------------------------------------|
|   max_length   | available on CharField, FileField                      |
|   min_length   ||
|   max_value    | available on IntegerField, FloatField, DecimalField    |
|   max_digits   | Decimal Field                                          |
| decimal_places | decimal_places = 3, input value: 12.24 => 12.240       |
|     label      | set the label test for a field                         |
|   help_text    | display after the field                                |
|   add_error    | None: non-field error. No specify which field is error |

### clean

* call super().clean()
    * for cross-field validation:
        * automatically get the form data to clean up
        * no parameters are required

# Upload Files

* Only POST requests support
    * impossible upload file through URL parameter: GET
* 前端可以上傳檔案到 request 參數，但是難做資料驗證
    * <!-- <input type="file" name="file_upload"> -->
    * request.FILES['file_upload']
* 後端可以將 request 收到的 form, 先轉到 forms.Form class, 進行資料驗證，最後傳回前端
    * form = UploadForm(request.POST, request.FILES)
    * form.cleaned_data['file_upload']

## Process

1. settings.py :
    ```
    if settings.DEBUG:
    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
    ```

### Context processors

## Process

1. settings.py :
    2. TEMPLATES: django.template.context_process.media'
       > To let MEDIA_URL as variable

## request.FILES

``upload = request.FILES['file-upload-name']``

|  Attribute   | Code                |
|:------------:|:--------------------|
|     size     | upload.size         |
|     name     | upload.name         |
| content-type | upload.content-type |
|   charset    | upload.charset      |

## Security

* when saving files to disk, generate a name instead of using the one provided by the uploader
    * when receiving files, check the file name extension matches the content type
        * Python library: mimetype

## Image file upload

``
picture_field = form.cleaned_data['picture']
image = picture_field.image
``

| Attribute  | Code                                             |
|:----------:|:-------------------------------------------------|
|   width    | image.w                                          |
|   height   | image.h                                          |
|   format   | image.f                                          |
| open image | from PIL import Image; Image.open(picture_field) |

### validate image

* Python library: pillow

### Middleware modules

* settings.py

|        Middleware        | Meaning                                                           |
|:------------------------:|:------------------------------------------------------------------|
|    SecurityMiddleware    | common security enhancements. e.g. SSL redirects, response header |
|    SessionMiddleware     | Session Support                                                   |
|     CommonMiddleware     | Miscellaneous features                                            |
|    CsrfViewMiddleware    | protection against Cross-site request forgery (CSRF)              |
| AuthenticationMiddleware | add user attribute to the request object                          | 
|    MessageMiddleware     | flash message                                                     |
| XFrameOptionsMiddleware  | protect against X-Frame-Options header clickjacking attacks       |

# Session

* settings.py
* all sessions require storing a session ID in a cookie
* Aware of legal policy to warn users if the site sets cookies in their browser
    * Django Simple Cookie Consent
    * Django Cookie Law

|    session_engine     | Meaning                                              |
|:---------------------:|:-----------------------------------------------------|
|    Cached sessions    | cache session information in memory or in a database |
|  File-based sessions  | for performance is not an issue                      |
| Cookie-based sessions | keep sessions entirely in the web browser cookie     |

## Session data

* store in schema: django_session
    * encoded in base64

* rules to store data in sessions
    1. key should be string
    2. key starts with underscore
    3. data only is encoded as JSON
    4. avoid reassigning request.session to different values at the same time
       > no: request.session = {'a': 30, 'b': 45}
       > ok: request.session['a'] = 30; request.session['b'] = 45

# Templates

## Filters

* create an app for filters

## Template Tags

|     Type      | Meaning                                                                                                                               |
|:-------------:|:--------------------------------------------------------------------------------------------------------------------------------------|
|  Simple Tag   | for variable data                                                                                                                     |
| Inclusion Tag | for data variables which are provides and generate an output; for rendering a template as a response to their usage inside a template |

# Restful API

* a connection between frontend website and backend server
    * frontend will know nothing and needs to retrieve the data through HTTP request from backend

## install

```commandline
pip install djangorestframework
```

## Rest Views

* function-based views: use `@api_view()` to return serialized json or other types of response instead of HttpResponse
    * Json or XML format helps translate information between Django and frontend by http request
* class-based views:
    * use ListAPIView, RetrieveAPIView
    * directly return responses instead of typing ``return Response(book_serializer.data)``
        * specify data: `queryset`
        * specify methods to serialize data: `serializer_class`

## serializer

* convert complex Python objects into formats, like JSON or XML
    * convert models data to serializers
    * define how to serialize
* Model Serializers: create serializers by using the definition of the fields on the model, instead of typing by users,
  e.g. models.charField..
    * class Meta

* StringRelatedField:
    * if only take one column from models
    * if take multiples column => define a customized Model Serializers

## viewsets

* a set of views in a single class
    * combine view classes into a single class
* ModelViewSet
    * allows to CURD model instances
* ReadOnlyModelViewSet
    * disallow CURD

## Routers

* automatically create required URL for viewsets
    * a viewset is accessed at different URLs

## Authentication

* Types
    * basic authentication
    * session authentication
    * token authentication
        * generate a unique token for a user in exchange for the user's username and password
        * token is unique
        * eliminate the needs to pass the username and password on every request
    * remote user authentication

## add authtoken

* settings.py - INSTALLED_APPS: 'rest_framework.authtoken'
* ``python manage.py migrate``
    * authtoken app has associated database changes
* 增加 login 的 view, 並提供 token
* 在其他 viewset 增加需要驗證。此後使用 viewset， headers 都要有 token

# Generate CSV, PDF, Other Binary files

## Csv

* DictReader
    * output: {column1: 'a', column2: 'b'} instead of [a, b]

## pdf

* package: weasyprint

## grpah

* package: plotly